(function(B,e,u){function F(d){function e(a,d,e){var f={chunks:"slice_blob",jpgresize:"send_binary_string",pngresize:"send_binary_string",progress:"report_upload_progress",multi_selection:"select_multiple",max_file_size:"access_binary",dragdrop:"drag_and_drop",drop_element:"drag_and_drop",headers:"send_custom_headers",canSendBinary:"send_binary",triggerDialog:"summon_file_dialog"};f[a]?p[f[a]]=d:e||(p[a]=d)}var f=d.required_features,p={};"string"===typeof f?a.each(f.split(/\s*,\s*/),function(a){e(a,!0)}):"object"===typeof f?a.each(f,function(a,d){e(d,a)}):!0===f&&(d.multipart||(p.send_binary_string=!0),0<d.chunk_size&&(p.slice_blob=!0),d.resize.enabled&&(p.send_binary_string=!0),a.each(d,function(a,d){e(d,!!a,!0)}));return p}var w=B.setTimeout,D={},a={VERSION:"2.1.0",STOPPED:1,STARTED:2,QUEUED:1,UPLOADING:2,FAILED:4,DONE:5,GENERIC_ERROR:-100,HTTP_ERROR:-200,IO_ERROR:-300,SECURITY_ERROR:-400,INIT_ERROR:-500,FILE_SIZE_ERROR:-600,FILE_EXTENSION_ERROR:-601,FILE_DUPLICATE_ERROR:-602,IMAGE_FORMAT_ERROR:-700,IMAGE_MEMORY_ERROR:-701,IMAGE_DIMENSIONS_ERROR:-702,mimeTypes:e.mimes,ua:e.ua,typeOf:e.typeOf,extend:e.extend,guid:e.guid,get:function(a){var d=[],f;"array"!==e.typeOf(a)&&(a=[a]);for(var p=a.length;p--;)(f=e.get(a[p]))&&d.push(f);return d.length?d:null},each:e.each,getPos:e.getPos,getSize:e.getSize,xmlEncode:function(a){var d={"\x3c":"lt","\x3e":"gt","\x26":"amp",'"':"quot","'":"#39"},e=/[<>&\"\']/g;return a?(""+a).replace(e,function(a){return d[a]?"\x26"+d[a]+";":a}):a},toArray:e.toArray,inArray:e.inArray,addI18n:e.addI18n,translate:e.translate,isEmptyObj:e.isEmptyObj,hasClass:e.hasClass,addClass:e.addClass,removeClass:e.removeClass,getStyle:e.getStyle,addEvent:e.addEvent,removeEvent:e.removeEvent,removeAllEvents:e.removeAllEvents,cleanName:function(a){var d,e;e=[/[\300-\306]/g,"A",/[\340-\346]/g,"a",/\307/g,"C",/\347/g,"c",/[\310-\313]/g,"E",/[\350-\353]/g,"e",/[\314-\317]/g,"I",/[\354-\357]/g,"i",/\321/g,"N",/\361/g,"n",/[\322-\330]/g,"O",/[\362-\370]/g,"o",/[\331-\334]/g,"U",/[\371-\374]/g,"u"];for(d=0;d<e.length;d+=2)a=a.replace(e[d],e[d+1]);a=a.replace(/\s+/g,"_");return a=a.replace(/[^a-z0-9_\-\.]+/gi,"")},buildUrl:function(d,e){var f="";a.each(e,function(a,d){f+=(f?"\x26":"")+encodeURIComponent(d)+"\x3d"+encodeURIComponent(a)});f&&(d+=(0<d.indexOf("?")?"\x26":"?")+f);return d},formatSize:function(d){function e(a,d){return Math.round(a*Math.pow(10,d))/Math.pow(10,d)}if(d===u||/\D/.test(d))return a.translate("N/A");var f=Math.pow(1024,4);return d>f?e(d/f,1)+" "+a.translate("tb"):d>(f/=1024)?e(d/f,1)+" "+a.translate("gb"):d>(f/=1024)?e(d/f,1)+" "+a.translate("mb"):1024<d?Math.round(d/1024)+" "+a.translate("kb"):d+" "+a.translate("b")},parseSize:e.parseSizeStr,predictRuntime:function(d,n){var f,p;f=new a.Uploader(d);p=e.Runtime.thatCan(f.getOption().required_features,n||d.runtimes);f.destroy();return p},addFileFilter:function(a,e){D[a]=e}};a.addFileFilter("mime_types",function(d,e,f){d.length&&!d.regexp.test(e.name)?(this.trigger("Error",{code:a.FILE_EXTENSION_ERROR,message:a.translate("File extension error."),file:e}),f(!1)):f(!0)});a.addFileFilter("max_file_size",function(d,e,f){d=a.parseSize(d);void 0!==e.size&&d&&e.size>d?(this.trigger("Error",{code:a.FILE_SIZE_ERROR,message:a.translate("File size error."),file:e}),f(!1)):f(!0)});a.addFileFilter("prevent_duplicates",function(d,e,f){if(d)for(d=this.files.length;d--;)if(e.name===this.files[d].name&&e.size===this.files[d].size){this.trigger("Error",{code:a.FILE_DUPLICATE_ERROR,message:a.translate("Duplicate file error."),file:e});f(!1);return}f(!0)});a.Uploader=function(d){function n(){var b,c=0,e;if(this.state==a.STARTED){for(e=0;e<m.length;e++)b||m[e].status!=a.QUEUED?c++:(b=m[e],this.trigger("BeforeUpload",b)&&(b.status=a.UPLOADING,this.trigger("UploadFile",b)));c==m.length&&(this.state!==a.STOPPED&&(this.state=a.STOPPED,this.trigger("StateChanged")),this.trigger("UploadComplete",m))}}function f(b){b.percent=0<b.size?Math.ceil(b.loaded/b.size*100):100;p()}function p(){var b,c;k.reset();for(b=0;b<m.length;b++)c=m[b],c.size!==u?(k.size+=c.origSize,k.loaded+=c.loaded*c.origSize/c.size):k.size=u,c.status==a.DONE?k.uploaded++:c.status==a.FAILED?k.failed++:k.queued++;k.size===u?k.percent=0<m.length?Math.ceil(k.uploaded/m.length*100):0:(k.bytesPerSec=Math.ceil(k.loaded/((+new Date-E||1)/1E3)),k.percent=0<k.size?Math.ceil(k.loaded/k.size*100):0)}function C(){var b=r[0]||x[0];return b?b.getRuntime().uid:!1}function B(b,a){if(b.ruid){var c=e.Runtime.getInfo(b.ruid);if(c)return c.can(a)}return!1}function G(b,c){var d=this,f=0,g=[],h={accept:b.filters.mime_types,runtime_order:b.runtimes,required_caps:b.required_features,preferred_caps:z,swf_url:b.flash_swf_url,xap_url:b.silverlight_xap_url};a.each(b.runtimes.split(/\s*,\s*/),function(a){b[a]&&(h[a]=b[a])});b.browse_button&&a.each(b.browse_button,function(c){g.push(function(g){var l=new e.FileInput(a.extend({},h,{name:b.file_data_name,multiple:b.multi_selection,container:b.container,browse_button:c}));l.onready=function(){var a=e.Runtime.getInfo(this.ruid);e.extend(d.features,{chunks:a.can("slice_blob"),multipart:a.can("send_multipart"),multi_selection:a.can("select_multiple")});f++;r.push(this);g()};l.onchange=function(){d.addFile(this.files)};l.bind("mouseenter mouseleave mousedown mouseup",function(a){A||(b.browse_button_hover&&("mouseenter"===a.type?e.addClass(c,b.browse_button_hover):"mouseleave"===a.type&&e.removeClass(c,b.browse_button_hover)),b.browse_button_active&&("mousedown"===a.type?e.addClass(c,b.browse_button_active):"mouseup"===a.type&&e.removeClass(c,b.browse_button_active)))});l.bind("error runtimeerror",function(){l=null;g()});l.init()})});b.drop_element&&a.each(b.drop_element,function(b){g.push(function(c){var l=new e.FileDrop(a.extend({},h,{drop_zone:b}));l.onready=function(){var a=e.Runtime.getInfo(this.ruid);d.features.dragdrop=a.can("drag_and_drop");f++;x.push(this);c()};l.ondrop=function(){d.addFile(this.files)};l.bind("error runtimeerror",function(){l=null;c()});l.init()})});e.inSeries(g,function(){"function"===typeof c&&c(f)})}function J(a,c,d){var b=new e.Image;try{b.onload=function(){b.downsize(c.width,c.height,c.crop,c.preserve_headers)},b.onresize=function(){d(this.getAsBlob(a.type,c.quality));this.destroy()},b.onerror=function(){d(a)},b.load(a)}catch(v){d(a)}}function H(b,c,d){function f(b,c,d){var e=g[b];switch(b){case "max_file_size":"max_file_size"===b&&(g.max_file_size=g.filters.max_file_size=c);break;case "chunk_size":if(c=a.parseSize(c))g[b]=c;break;case "filters":"array"===a.typeOf(c)&&(c={mime_types:c});d?a.extend(g.filters,c):g.filters=c;c.mime_types&&(g.filters.mime_types.regexp=function(b){var c=[];a.each(b,function(b){a.each(b.extensions.split(/,/),function(a){/^\s*\*\s*$/.test(a)?c.push("\\.*"):c.push("\\."+a.replace(new RegExp("["+"/^$.*+?|()[]{}\\".replace(/./g,"\\$\x26")+"]","g"),"\\$\x26"))})});return new RegExp("("+c.join("|")+")$","i")}(g.filters.mime_types));break;case "resize":d?a.extend(g.resize,c,{enabled:!0}):g.resize=c;break;case "prevent_duplicates":g.prevent_duplicates=g.filters.prevent_duplicates=!!c;break;case "browse_button":case "drop_element":c=a.get(c);case "container":case "runtimes":case "multi_selection":case "flash_swf_url":case "silverlight_xap_url":g[b]=c;d||(k=!0);break;default:g[b]=c}d||h.trigger("OptionChanged",b,c,e)}var h=this,k=!1;"object"===typeof b?a.each(b,function(a,b){f(b,a,d)}):f(b,c,d);d?(g.required_features=F(a.extend({},g)),z=F(a.extend({},g,{required_features:!0}))):k&&(h.trigger("Destroy"),G.call(h,g,function(b){b?(h.runtime=e.Runtime.getInfo(C()).type,h.trigger("Init",{runtime:h.runtime}),h.trigger("PostInit")):h.trigger("Error",{code:a.INIT_ERROR,message:a.translate("Init error.")})}))}function K(a,c){[].push.apply(m,c);a.trigger("QueueChanged");a.refresh()}function L(a,c){if(g.unique_names){var b=c.name.match(/\.([^.]+)$/),d="part";b&&(d=b[1]);c.target_name=c.id+"."+d}}function M(b,c){function d(){0<m--?w(f,1E3):(c.loaded=l,b.trigger("Error",{code:a.HTTP_ERROR,message:a.translate("HTTP Error."),file:c,response:h.responseText,status:h.status,responseHeaders:h.getAllResponseHeaders()}))}function f(){var n,y,t,v;c.status!=a.DONE&&c.status!=a.FAILED&&b.state!=a.STOPPED&&(t={name:c.target_name||c.name},k&&p.chunks&&q.size>k?(v=Math.min(k,q.size-l),n=q.slice(l,l+v)):(v=q.size,n=q),k&&p.chunks&&(b.settings.send_chunk_number?(t.chunk=Math.ceil(l/k),t.chunks=Math.ceil(q.size/k)):(t.offset=l,t.total=q.size)),h=new e.XMLHttpRequest,h.upload&&(h.upload.onprogress=function(a){c.loaded=Math.min(c.size,l+a.loaded);b.trigger("UploadProgress",c)}),h.onload=function(){400<=h.status?d():(m=b.settings.max_retries,v<q.size?(n.destroy(),l+=v,c.loaded=Math.min(l,q.size),b.trigger("ChunkUploaded",c,{offset:c.loaded,total:q.size,response:h.responseText,status:h.status,responseHeaders:h.getAllResponseHeaders()}),"Android Browser"===e.Env.browser&&b.trigger("UploadProgress",c)):c.loaded=c.size,n=y=null,!l||l>=q.size?(c.size!=c.origSize&&(q.destroy(),q=null),b.trigger("UploadProgress",c),c.status=a.DONE,b.trigger("FileUploaded",c,{response:h.responseText,status:h.status,responseHeaders:h.getAllResponseHeaders()})):w(f,1))},h.onerror=function(){d()},h.onloadend=function(){this.destroy();h=null},b.settings.multipart&&p.multipart?(t.name=c.target_name||c.name,h.open("post",g,!0),a.each(b.settings.headers,function(a,b){h.setRequestHeader(b,a)}),y=new e.FormData,a.each(a.extend(t,b.settings.multipart_params),function(a,b){y.append(b,a)}),y.append(b.settings.file_data_name,n),h.send(y,{runtime_order:b.settings.runtimes,required_caps:b.settings.required_features,preferred_caps:z,swf_url:b.settings.flash_swf_url,xap_url:b.settings.silverlight_xap_url})):(g=a.buildUrl(b.settings.url,a.extend(t,b.settings.multipart_params)),h.open("post",g,!0),h.setRequestHeader("Content-Type","application/octet-stream"),a.each(b.settings.headers,function(a,b){h.setRequestHeader(b,a)}),h.send(n,{runtime_order:b.settings.runtimes,required_caps:b.settings.required_features,preferred_caps:z,swf_url:b.settings.flash_swf_url,xap_url:b.settings.silverlight_xap_url})))}var g=b.settings.url,k=b.settings.chunk_size,m=b.settings.max_retries,p=b.features,l=0,q;c.loaded&&(l=c.loaded=k*Math.floor(c.loaded/k));q=c.getSource();b.settings.resize.enabled&&B(q,"send_binary_string")&&~e.inArray(q.type,["image/jpeg","image/png"])?J.call(this,q,b.settings.resize,function(a){q=a;c.size=a.size;f()}):f()}function N(a,c){f(c)}function O(b){if(b.state==a.STARTED)E=+new Date;else if(b.state==a.STOPPED)for(var c=b.files.length-1;0<=c;c--)b.files[c].status==a.UPLOADING&&(b.files[c].status=a.QUEUED,p())}function P(){h&&h.abort()}function Q(a){p();w(function(){n.call(a)},1)}function R(b,c){c.file&&(c.file.status=a.FAILED,f(c.file),b.state==a.STARTED&&(b.trigger("CancelUpload"),w(function(){n.call(b)},1)))}function S(b){b.stop();a.each(m,function(a){a.destroy()});m=[];r.length&&(a.each(r,function(a){a.destroy()}),r=[]);x.length&&(a.each(x,function(a){a.destroy()}),x=[]);z={};A=!1;g=E=h=null;k.reset()}var I=a.guid(),g,m=[],z={},r=[],x=[],E,k,A=!1,h;g={runtimes:e.Runtime.order,max_retries:0,chunk_size:0,multipart:!0,multi_selection:!0,file_data_name:"file",flash_swf_url:"js/Moxie.swf",silverlight_xap_url:"js/Moxie.xap",filters:{mime_types:[],prevent_duplicates:!1,max_file_size:0},resize:{enabled:!1,preserve_headers:!0,crop:!1},send_chunk_number:!0};H.call(this,d,null,!0);k=new a.QueueProgress;a.extend(this,{id:I,uid:I,state:a.STOPPED,features:{},runtime:null,files:m,settings:g,total:k,init:function(){var b=this;"function"==typeof g.preinit?g.preinit(b):a.each(g.preinit,function(a,d){b.bind(d,a)});g.browse_button&&g.url?(this.bind("FilesAdded",K),this.bind("CancelUpload",P),this.bind("BeforeUpload",L),this.bind("UploadFile",M),this.bind("UploadProgress",N),this.bind("StateChanged",O),this.bind("QueueChanged",p),this.bind("Error",R),this.bind("FileUploaded",Q),this.bind("Destroy",S),G.call(this,g,function(c){"function"==typeof g.init?g.init(b):a.each(g.init,function(a,c){b.bind(c,a)});c?(b.runtime=e.Runtime.getInfo(C()).type,b.trigger("Init",{runtime:b.runtime}),b.trigger("PostInit")):b.trigger("Error",{code:a.INIT_ERROR,message:a.translate("Init error.")})})):this.trigger("Error",{code:a.INIT_ERROR,message:a.translate("Init error.")})},setOption:function(a,c){H.call(this,a,c,!this.runtime)},getOption:function(a){return a?g[a]:g},refresh:function(){r.length&&a.each(r,function(a){a.trigger("Refresh")});this.trigger("Refresh")},start:function(){this.state!=a.STARTED&&(this.state=a.STARTED,this.trigger("StateChanged"),n.call(this))},stop:function(){this.state!=a.STOPPED&&(this.state=a.STOPPED,this.trigger("StateChanged"),this.trigger("CancelUpload"))},disableBrowse:function(b){A=b!==u?b:!0;r.length&&a.each(r,function(a){a.disable(A)});this.trigger("DisableBrowse",A)},getFile:function(a){var b;for(b=m.length-1;0<=b;b--)if(m[b].id===a)return m[b]},addFile:function(b,c){function d(a,b){var c=[];e.each(g.settings.filters,function(b,d){D[d]&&c.push(function(c){D[d].call(g,b,a,function(a){c(!a)})})});e.inSeries(c,b)}function f(b){var l=e.typeOf(b);if(b instanceof e.File){if(!b.ruid&&!b.isDetached()){if(!m)return!1;b.ruid=m;b.connectRuntime(m)}f(new a.File(b))}else b instanceof e.Blob?(f(b.getSource()),b.destroy()):b instanceof a.File?(c&&(b.name=c),h.push(function(a){d(b,function(c){c||(k.push(b),g.trigger("FileFiltered",b));w(a,1)})})):-1!==e.inArray(l,["file","blob"])?f(new e.File(null,b)):"node"===l&&"filelist"===e.typeOf(b.files)?e.each(b.files,f):"array"===l&&(c=null,e.each(b,f))}var g=this,h=[],k=[],m;m=C();f(b);h.length&&e.inSeries(h,function(){k.length&&g.trigger("FilesAdded",k)})},removeFile:function(a){a="string"===typeof a?a:a.id;for(var b=m.length-1;0<=b;b--)if(m[b].id===a)return this.splice(b,1)[0]},splice:function(b,c){var d=m.splice(b===u?0:b,c===u?m.length:c),e=!1;this.state==a.STARTED&&(e=!0,this.stop());this.trigger("FilesRemoved",d);a.each(d,function(a){a.destroy()});this.trigger("QueueChanged");this.refresh();e&&this.start();return d},bind:function(b,c,d){var e=this;a.Uploader.prototype.bind.call(this,b,function(){var a=[].slice.call(arguments);a.splice(0,1,e);return c.apply(this,a)},0,d)},destroy:function(){this.trigger("Destroy");k=null;this.unbindAll()}})};a.Uploader.prototype=e.EventTarget.instance;a.File=function(){var d={};return function(n){a.extend(this,{id:a.guid(),name:n.name||n.fileName,type:n.type||"",size:n.size||n.fileSize,origSize:n.size||n.fileSize,loaded:0,percent:0,status:a.QUEUED,lastModifiedDate:n.lastModifiedDate||(new Date).toLocaleString(),getNative:function(){var a=this.getSource().getSource();return-1!==e.inArray(e.typeOf(a),["blob","file"])?a:null},getSource:function(){return d[this.id]?d[this.id]:null},destroy:function(){var a=this.getSource();a&&(a.destroy(),delete d[this.id])}});d[this.id]=n}}();a.QueueProgress=function(){var a=this;a.size=0;a.loaded=0;a.uploaded=0;a.failed=0;a.queued=0;a.percent=0;a.bytesPerSec=0;a.reset=function(){a.size=a.loaded=a.uploaded=a.failed=a.queued=a.percent=a.bytesPerSec=0}};B.plupload=a})(window,mOxie);